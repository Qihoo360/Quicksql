#!/bin/bash

 if [ -z "${QSQL_HOME}" ]
 then
    export QSQL_HOME="$(cd "`dirname "$0"`"/..; pwd)"
 fi

 JAR_FILE="${QSQL_HOME}/lib/flink/qsql-core-0.6.jar"

 if [ ! -f "${JAR_FILE}" ]; then
    echo "INFO: Start build flink fat jar...";
    mkdir ${QSQL_HOME}/lib/flink/tmp

    cp ${QSQL_HOME}/lib/flink/*.jar ${QSQL_HOME}/lib/flink/tmp/
    if [ -z "${HADOOP_HOME}" ]
     then
       echo "WARN: HADOOP_HOME is not set";
    else
       cp "`find ${HADOOP_HOME}/ -name "hadoop-common*.jar" |head -n 1`"  ${QSQL_HOME}/lib/flink/tmp
    fi

    cd ${QSQL_HOME}/lib/flink/tmp

    for jar_file in $(ls *.jar | grep -v "qsql-core-0.6-fat.jar"); do
        jar -xf ${jar_file}
    done
    rm -rf META-INF

    jar -xf qsql-core-0.6-fat.jar
    if [ $? -ne 0 ]; then
       echo "ERROR: File qsql-core-0.6-fat.jar is not exist.";
       exit 1
    fi

    ls |grep -v jar$ | xargs jar cfM qsql-core-0.6.jar
    if [ $? -ne 0 ]; then
       echo "ERROR: Failed buid flink fat jar qsql-core-0.6.jar.";
       exit 1
    fi

    mv qsql-core-0.6.jar ${QSQL_HOME}/lib/flink
    cd ../../
    rm -rf ${QSQL_HOME}/lib/flink/tmp
    echo "INFO: End build flink fat jar.";
 fi

